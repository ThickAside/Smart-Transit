<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SmartTransit ‚Äî Live Bus Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* Custom animations */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(18px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ani-fade-up { animation: fadeUp .7s ease-out both; }

        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 999px; }

        /* Leaflet container fix */
        #map .leaflet-control-container { border-radius: 16px; overflow: hidden; }

        /* Input icon style */
        .input-icon { width: 1.4rem; height: 1.4rem; opacity: .85; }

        /* Timeline styles */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 1.25rem;
            bottom: -1.25rem;
            width: 2px;
            background-color: #e5e7eb;
            transform: translateX(-50%);
        }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot {
            position: absolute;
            left: 1.25rem;
            top: 1.25rem;
            transform: translate(-50%, -50%);
        }
        .bus-icon { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        
        /* Ensure overlays and dropdowns sit above Leaflet map */
        .ui-overlay { z-index: 5000 !important; }
        .ui-dropdown { z-index: 3000 !important; }
        /* Tame Leaflet stacking so it never eclipse overlays */
        #map, #map .leaflet-pane, #map .leaflet-top, #map .leaflet-bottom { z-index: 0 !important; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <header class="relative bg-gradient-to-r from-indigo-600 via-indigo-500 to-indigo-400">
        <nav class="sticky top-0 z-40 flex justify-between items-center p-4 bg-white/80 backdrop-blur-md shadow-lg">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600/20 p-2 rounded-full">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 10h14v6H3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="7.5" cy="17.5" r="1.5" fill="currentColor"/>
                        <circle cx="13.5" cy="17.5" r="1.5" fill="currentColor"/>
                    </svg>
                </div>
                <div class="text-indigo-600 font-bold text-xl">SmartTransit</div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <button id="bookingsLink" class="text-gray-600 hover:text-indigo-600 px-3 py-1">Bookings</button>
                    <div id="bookingsDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" id="yourBookings">Your Bookings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" id="previousBookings">Previous Bookings</a>
                    </div>
                </div>
                <a class="text-gray-600 hover:text-indigo-600 px-3 py-1" href="#" id="helpLink">Help</a>
                <div class="relative">
                    <button id="accountBtn" class="bg-white/20 text-gray-600 px-3 py-1 rounded-full hover:bg-indigo-100">Account</button>
                    <div id="accountDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
                <a href="#" id="routeMapLink" class="bg-white text-blue-600 px-4 py-3 rounded-full shadow-lg hover:bg-gray-100 text-lg font-semibold" data-translate="route_map_link">üó∫Ô∏è Route Map</a>
                <select id="language-selector" class="appearance-none bg-white border border-gray-300 text-gray-800 py-2 pl-3 pr-8 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg shadow-lg transition duration-300">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
                </select>
                <button onclick="toggleChatbot()" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700" data-translate="chat_btn">üí¨ Chat</button>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 lg:px-8 pb-16 pt-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                <div class="text-white">
                    <h1 class="text-4xl md:text-5xl font-extrabold leading-tight drop-shadow-lg" data-translate="main_heading">India's No.1 bus tracking & booking experience</h1>
                    <p class="mt-4 text-lg text-white/90 max-w-xl" data-translate="main_subheading">Real-time vehicle locations, smart ETA predictions and easy route planning ‚Äî all in one place.</p>
                </div>
                <div class="flex justify-center lg:justify-end">
                    <div class="w-[380px] h-[220px] bg-white/8 rounded-2xl p-6 flex items-center justify-center drop-shadow-xl">
                        <svg viewBox="0 0 700 400" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                            <defs>
                                <linearGradient id="g1" x1="0" x2="1">
                                    <stop offset="0" stop-color="#60A5FA"/>
                                    <stop offset="1" stop-color="#7C3AED"/>
                                </linearGradient>
                            </defs>
                            <rect rx="24" width="100%" height="100%" fill="url(#g1)" opacity="0.15"/>
                            <rect x="0" y="220" width="100%" height="120" fill="#E6EEF9"/>
                            <g transform="translate(90,110) scale(0.9)">
                                <rect x="0" y="40" rx="18" ry="18" width="420" height="130" fill="#ef4444" />
                                <rect x="24" y="60" rx="10" ry="10" width="220" height="62" fill="#fff3f3" opacity="0.9"/>
                                <circle cx="90" cy="188" r="20" fill="#111827"/>
                                <circle cx="330" cy="188" r="20" fill="#111827"/>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 lg:px-8 -mt-24">
        <div class="col-span-full">
            <div class="mx-auto px-4">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-4 md:p-5 ani-fade-up">
                    <form id="searchForm" class="flex flex-col md:flex-row items-center gap-4">
                        <div class="w-full md:flex-grow flex items-center gap-3 bg-white rounded-lg px-3 py-2.5 border">
                            <svg class="input-icon text-gray-500" viewBox="0 0 24 24" fill="none"><path d="M3 10h14v6H3z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <input id="fromInput" type="text" placeholder="From" class="w-full outline-none text-gray-800" />
                        </div>
                        <div class="w-full md:flex-grow flex items-center gap-3 bg-white rounded-lg px-3 py-2.5 border">
                            <svg class="input-icon text-gray-500" viewBox="0 0 24 24" fill="none"><path d="M21 10H7v6h14z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <input id="toInput" type="text" placeholder="To" class="w-full outline-none text-gray-800" />
                        </div>
                        <div class="w-full md:w-auto flex items-center">
                            <input id="dateInput" type="date" class="w-full outline-none text-gray-800 border rounded-lg px-3 py-2.5" />
                        </div>
                        <div class="w-full md:w-auto">
                            <button class="w-full md:w-auto bg-red-600 text-white px-8 py-2.5 rounded-lg font-semibold shadow hover:shadow-lg transition" type="submit">
                                Search Buses
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <section class="mt-8 bg-white rounded-xl shadow px-6 py-5 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="p-3 rounded-lg bg-green-50">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 20h9" stroke="#10B981" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div>
                    <div class="font-semibold text-gray-800" data-translate="festive_offer">Book trains for festivals</div>
                    <div class="text-sm text-gray-500" data-translate="offer_code">Get ‚Çπ100 off using code <span class="font-semibold text-green-600">FESTIVE</span></div>
                </div>
            </div>
            <div class="text-sm text-gray-600" data-translate="punjab_bookings">25,000+ people booked from Punjab last month</div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div class="lg:col-span-3 bg-white rounded-2xl shadow p-4">
                <h2 class="text-3xl font-bold text-blue-700 mb-4" data-translate="live_map_title">üìç Live Map with Vehicles & Bus Stops</h2>
                <div id="map" class="w-full h-96 rounded-xl overflow-hidden border border-gray-100"></div>
                <div class="mt-3 flex items-center gap-3">
                    <button onclick="refreshLocation()" class="bg-white border px-4 py-2 rounded-lg shadow-sm hover:scale-105 transition" data-translate="refresh_location_btn">Refresh My Location</button>
                    <button onclick="updateVehicleMarkers()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:scale-105 transition" data-translate="refresh_vehicles_btn">Refresh Vehicles</button>
                </div>
            </div>
        </section>

        <section id="mainContent" class="p-6 bg-gray-100 rounded shadow mt-6">
            <h2 class="text-3xl font-bold text-blue-700 mb-4" data-translate="where_is_my_bus_title">üîç Where is my Bus?</h2>
            <div class="flex bg-gray-200 rounded-lg p-1 mb-4">
                <button id="tab-route" class="flex-1 py-2 px-4 rounded-md text-sm font-semibold bg-white text-blue-600 shadow" data-translate="by_route_tab">By Route</button>
                <button id="tab-number" class="flex-1 py-2 px-4 rounded-md text-sm font-semibold text-gray-600" data-translate="by_bus_number_tab">By Bus Number</button>
            </div>
            <div id="search-forms">
                <form id="form-route" class="space-y-4">
                    <div>
                        <label for="start-point" class="block text-sm font-medium text-gray-700" data-translate="from_label">From</label>
                        <input type="text" id="start-point" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Kadgil" data-translate="from_placeholder">
                    </div>
                    <div>
                        <label for="destination" class="block text-sm font-medium text-gray-700" data-translate="to_label">To</label>
                        <input type="text" id="destination" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Tarn Taran Bus Stand" data-translate="to_placeholder">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate="find_buses_btn">
                        Find Buses
                    </button>
                </form>
                <form id="form-number" class="space-y-4 hidden">
                    <div>
                        <label for="bus-number" class="block text-sm font-medium text-gray-700" data-translate="bus_number_label">Bus Number</label>
                        <input type="text" id="bus-number" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 58" data-translate="bus_number_placeholder">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate="track_bus_btn">
                        Track Bus
                    </button>
                </form>
            </div>
            <div id="results" class="mt-6"></div>
            <div id="history-container" class="mt-8">
                <h3 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-3" data-translate="recent_searches_title">Recent Searches</h3>
                <div id="history-list" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm" data-translate="search_history_placeholder">Your search history will appear here.</p>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
            <div class="p-6 bg-blue-100 rounded shadow">
                <h3 class="text-2xl font-semibold" data-translate="predictive_eta_title">üß† Predictive ETA</h3>
                <label class="block mt-3" data-translate="start_location_label">Start Location:</label>
                <input type="text" id="etaStartLocation" class="p-2 border rounded w-full"
                    placeholder="e.g., Kadgil" data-translate="from_placeholder"/>
                <label class="block mt-3" data-translate="destination_label">Destination:</label>
                <input type="text" id="etaEndLocation" class="p-2 border rounded w-full"
                    placeholder="e.g., Tarn Taran Bus Stand" data-translate="to_kashmere_placeholder"/>
                <button onclick="calculatePredictiveETA()"
                    class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" data-translate="predict_eta_btn">Predict
                    ETA</button>
                <div id="predictiveEtaResult"
                    class="mt-4 p-3 bg-white rounded text-blue-800" data-translate="prediction_placeholder">Prediction will appear here...</div>
            </div>
            <div class="p-6 bg-green-100 rounded shadow">
                <h3 class="text-2xl font-semibold" data-translate="route_planner_title">üó∫ Smart Route Planner</h3>
                <label class="block mt-3" data-translate="start_location_label">Start Location:</label>
                <input type="text" id="startLocationPlanner" class="p-2 border rounded w-full"
                    placeholder="e.g., Bathinda Bus Stand" data-translate="from_placeholder"/>
                <label class="block mt-3" data-translate="destination_label">Destination:</label>
                <input type="text" id="endLocationPlanner" class="p-2 border rounded w-full"
                    placeholder="e.g., Talwandi Sabo Bus Stand" data-translate="to_placeholder"/>
                <button onclick="findBestRoute()"
                    class="mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" data-translate="find_best_route_btn">Find
                    Best Route</button>
                <div id="routeRecommendation"
                    class="mt-4 p-4 bg-white rounded text-green-800 shadow" data-translate="route_reco_placeholder">Enter locations to get
                    the best transport option recommendation.</div>
            </div>
        </section>

        <section class="p-6 bg-gray-100 rounded shadow mt-6">
            <h3 class="text-2xl font-semibold" data-translate="incident_report_title">‚õì Immutable Incident Reporting</h3>
            <textarea id="reportInput" rows="4"
                class="w-full p-3 border rounded mt-2"
                placeholder="Report delay, breakdown, or incident..." data-translate="incident_placeholder"></textarea>
            <button onclick="submitImmutableReport()"
                class="mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" data-translate="submit_report_btn">Submit
                Report</button>
            <div id="reportChain"
                class="mt-6 max-h-96 overflow-y-auto bg-white p-4 rounded shadow"></div>
        </section>

        <footer class="mt-10 mb-16 text-sm text-gray-600">
            <div class="max-w-7xl mx-auto" data-translate="footer_text">Made with ‚ù§ ‚Äî SmartTransit Prototype</div>
        </footer>
    </main>

    <div id="routeMapModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 ui-overlay">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 h-5/6 p-4 relative flex flex-col overflow-hidden">
            <button id="closeMapBtn" class="absolute top-4 right-4 text-gray-700 hover:text-black text-3xl font-bold z-10">&times;</button>
            <h2 class="text-2xl font-bold text-center mb-2 flex-shrink-0" data-translate="punjab_bus_map_title">Punjab Bus Route Map</h2>
            <div class="flex-grow relative border rounded-lg bg-gray-50" id="routeMapContainer">
                <svg id="routeMapSvg" width="100%" height="100%" style="cursor: grab;"></svg>
            </div>
            <div id="routeMapLegend" class="flex-shrink-0 flex flex-wrap justify-center gap-x-6 gap-y-2 mt-2 p-2 bg-gray-100 rounded"></div>
        </div>
    </div>

    <div id="chatbot-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ui-overlay">
        <div class="bg-white rounded-lg shadow-lg w-80 p-4 relative">
            <h3 class="text-xl font-bold text-blue-600 mb-2" data-translate="chatbot_title">Mr. Conductor</h3>
            <div id="chat-output" class="h-60 overflow-y-auto border p-2 mb-2 bg-gray-100 rounded"></div>
            <input type="text" id="chat-input" placeholder="Ask something..." class="w-full p-2 border rounded" data-translate="chatbot_placeholder"/>
            <button onclick="handleChat()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" data-translate="send_btn">Send</button>
            <button onclick="toggleChatbot()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">‚úñ</button>
        </div>
    </div>

    <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ui-overlay">
        <div class="bg-white rounded-lg shadow-lg w-auto p-6 relative text-center">
            <h3 class="text-xl font-bold text-blue-600 mb-4" data-translate="confirm_boarding_pass">Confirm Your Boarding Pass</h3>
            <div id="boarding-pass-details" class="p-4 bg-gray-100 rounded-lg"></div>
            <button id="confirmBooking" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" data-translate="get_pass">Get Pass</button>
            <button id="closeBookingModal" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
    </div>

    <div id="bookingsDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ui-overlay">
        <div class="bg-white rounded-lg shadow-lg w-1/3 p-6 relative">
            <h3 id="bookingDetailsTitle" class="text-2xl font-bold text-blue-600 mb-4">Your Bookings</h3>
            <div id="bookingDetailsContent" class="space-y-4">
                </div>
            <button id="closeBookingsDetailsModal" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ui-overlay">
        <div class="bg-white rounded-lg shadow-lg w-1/2 p-6 relative max-h-[80vh] flex flex-col">
            <h3 class="text-2xl font-bold text-blue-600 mb-4" data-translate="help_center">Help Center</h3>
            <div id="faq-section" class="overflow-y-auto"></div>
            <button id="closeHelpModal" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, doc, setDoc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Translations and language selector
        const translations = {
            en: {
                route_map_link: "üó∫Ô∏è Route Map",
                punjab_bus_map_title: "Punjab Bus Route Map",
                chat_btn: "üí¨ Chat",
                main_title: "üöè SmartTransit",
                main_subtitle: "Real-time Public Transport Tracking & Smart ETA Prediction. Making urban mobility smarter, faster, and more reliable.",
                explore_app_btn: "Explore the App",
                live_map_title: "üìç Live Map with Vehicles & Bus Stops",
                refresh_location_btn: "Refresh My Location",
                where_is_my_bus_title: "üîç Where is my Bus?",
                by_route_tab: "By Route",
                by_bus_number_tab: "By Bus Number",
                from_label: "From",
                from_placeholder: "e.g., Kadgil",
                to_label: "To",
                to_placeholder: "e.g., Tarn Taran Bus Stand",
                find_buses_btn: "Find Buses",
                bus_number_label: "Bus Number",
                bus_number_placeholder: "e.g., 58",
                track_bus_btn: "Track Bus",
                recent_searches_title: "Recent Searches",
                search_history_placeholder: "Your search history will appear here.",
                predictive_eta_title: "üß† Predictive ETA",
                start_location_label: "Start Location:",
                destination_label: "Destination:",
                to_kashmere_placeholder: "e.g., Tarn Taran Bus Stand",
                predict_eta_btn: "Predict ETA",
                prediction_placeholder: "Prediction will appear here...",
                route_planner_title: "üó∫ Smart Route Planner",
                find_best_route_btn: "Find Best Route",
                route_reco_placeholder: "Enter locations to get the best transport option recommendation.",
                incident_report_title: "‚õì Immutable Incident Reporting",
                incident_placeholder: "Report delay, breakdown, or incident...",
                submit_report_btn: "Submit Report",
                chatbot_title: "Mr. Conductor",
                chatbot_placeholder: "Ask something...",
                send_btn: "Send",
                main_heading: "India's No.1 bus tracking & booking experience",
                main_subheading: "Real-time vehicle locations, smart ETA predictions and easy route planning ‚Äî all in one place.",
                search_buses: "üîç Bus‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                festive_offer: "Book trains for festivals",
                offer_code: "Get ‚Çπ100 off using code FESTIVE",
                punjab_bookings: "25,000+ people booked from Punjab last month",
                refresh_vehicles_btn: "Refresh Vehicles",
                footer_text: "Made with ‚ù§ ‚Äî SmartTransit Prototype",
                confirm_boarding_pass: "Confirm Your Boarding Pass",
                get_pass: "Get Pass",
                help_center: "Help Center",
            },
            hi: {
                route_map_link: "üó∫Ô∏è ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§®‡§ï‡•ç‡§∂‡§æ",
                punjab_bus_map_title: "‡§™‡§Ç‡§ú‡§æ‡§¨ ‡§¨‡§∏ ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§®‡§ï‡•ç‡§∂‡§æ",
                chat_btn: "üí¨ ‡§ö‡•à‡§ü",
                main_title: "üöè ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡§ø‡§ü",
                main_subtitle: "‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§™‡§∞‡§ø‡§µ‡§π‡§® ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó ‡§î‡§∞ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§à‡§ü‡•Ä‡§è ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä‡•§ ‡§∂‡§π‡§∞‡•Ä ‡§ó‡§§‡§ø‡§∂‡•Ä‡§≤‡§§‡§æ ‡§ï‡•ã ‡§π‡•ã‡§∂‡§ø‡§Ø‡§æ‡§∞, ‡§§‡•á‡§ú ‡§î‡§∞ ‡§Ö‡§ß‡§ø‡§ï ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§¨‡§®‡§æ‡§®‡§æ‡•§",
                explore_app_btn: "‡§ê‡§™ ‡§ï‡§æ ‡§Ö‡§®‡•ç‡§µ‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç",
                live_map_title: "üìç ‡§µ‡§æ‡§π‡§®‡•ã‡§Ç ‡§î‡§∞ ‡§¨‡§∏ ‡§∏‡•ç‡§ü‡•â‡§™ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§≤‡§æ‡§á‡§µ ‡§®‡§ï‡•ç‡§∂‡§æ",
                refresh_location_btn: "‡§Æ‡•á‡§∞‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§§‡§æ‡§ú‡§º‡§æ ‡§ï‡§∞‡•á‡§Ç",
                where_is_my_bus_title: " ‡§Æ‡•á‡§∞‡•Ä ‡§¨‡§∏ ‡§ï‡§π‡§æ‡§Å ‡§π‡•à?",
                by_route_tab: "‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§∏‡•á",
                by_bus_number_tab: "‡§¨‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á",
                from_label: "‡§∏‡•á",
                from_placeholder: "‡§â‡§¶‡§æ., ‡§ï‡§°‡§ó‡§ø‡§≤",
                to_label: "‡§§‡§ï",
                to_placeholder: "‡§â‡§¶‡§æ., ‡§§‡§∞‡§®‡§§‡§æ‡§∞‡§® ‡§¨‡§∏ ‡§∏‡•ç‡§ü‡•à‡§Ç‡§°",
                find_buses_btn: "‡§¨‡§∏‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                bus_number_label: "‡§¨‡§∏ ‡§®‡§Ç‡§¨‡§∞",
                bus_number_placeholder: "‡§â‡§¶‡§æ., 58",
                track_bus_btn: "‡§¨‡§∏ ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç",
                recent_searches_title: "‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                search_history_placeholder: "‡§Ü‡§™‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡§æ‡•§",
                predictive_eta_title: "üß† ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡§π‡§®‡•á‡§µ‡§æ‡§≤‡§æ ‡§à‡§ü‡•Ä‡§è",
                start_location_label: "‡§Ü‡§∞‡§Ç‡§≠ ‡§∏‡•ç‡§•‡§æ‡§®:",
                destination_label: "‡§ó‡§Ç‡§§‡§µ‡•ç‡§Ø:",
                to_kashmere_placeholder: "‡§â‡§¶‡§æ., ‡§§‡§∞‡§®‡§§‡§æ‡§∞‡§® ‡§¨‡§∏ ‡§∏‡•ç‡§ü‡•à‡§Ç‡§°",
                predict_eta_btn: "‡§à‡§ü‡•Ä‡§è ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç",
                prediction_placeholder: "‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡•Ä...",
                route_planner_title: "üó∫ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡§æ‡§∞",
                find_best_route_btn: "‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                route_reco_placeholder: "‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§™‡§∞‡§ø‡§µ‡§π‡§® ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§ï‡•Ä ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§•‡§æ‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
                incident_report_title: "‚õì ‡§Ö‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®‡•Ä‡§Ø ‡§ò‡§ü‡§®‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó",
                incident_placeholder: "‡§¶‡•á‡§∞‡•Ä, ‡§ü‡•Ç‡§ü‡§®‡•á, ‡§Ø‡§æ ‡§ò‡§ü‡§®‡§æ ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç...",
                submit_report_btn: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç",
                chatbot_title: "‡§∂‡•ç‡§∞‡•Ä ‡§ï‡§Ç‡§°‡§ï‡•ç‡§ü‡§∞",
                chatbot_placeholder: "‡§ï‡•Å‡§õ ‡§™‡•Ç‡§õ‡•á‡§Ç...",
                send_btn: "‡§≠‡•á‡§ú‡•á‡§Ç",
                main_heading: "‡§≠‡§æ‡§∞‡§§ ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ 1 ‡§¨‡§∏ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó ‡§î‡§∞ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§Ö‡§®‡•Å‡§≠‡§µ",
                main_subheading: "‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§µ‡§æ‡§π‡§® ‡§∏‡•ç‡§•‡§æ‡§®, ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§à‡§ü‡•Ä‡§è ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡§ø‡§Ø‡§æ‡§Ç ‡§î‡§∞ ‡§Ü‡§∏‡§æ‡§® ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§Ø‡•ã‡§ú‡§®‡§æ - ‡§∏‡§¨ ‡§è‡§ï ‡§π‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞‡•§",
                search_buses: "üîç ‡§¨‡§∏‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                festive_offer: "‡§§‡•ç‡§Ø‡•ã‡§π‡§æ‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•ç‡§∞‡•á‡§® ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç",
                offer_code: "FESTIVE ‡§ï‡•ã‡§° ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‚Çπ100 ‡§ï‡•Ä ‡§õ‡•Ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç",
                punjab_bookings: "‡§™‡§ø‡§õ‡§≤‡•á ‡§Æ‡§π‡•Ä‡§®‡•á ‡§™‡§Ç‡§ú‡§æ‡§¨ ‡§∏‡•á 25,000 ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§≤‡•ã‡§ó‡•ã‡§Ç ‡§®‡•á ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•Ä",
                refresh_vehicles_btn: "‡§µ‡§æ‡§π‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§§‡§æ‡§ú‡§º‡§æ ‡§ï‡§∞‡•á‡§Ç",
                footer_text: "‚ù§ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ - ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü‡§ü‡•ç‡§∞‡§æ‡§Ç‡§ú‡§ø‡§ü ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™",
                confirm_boarding_pass: "‡§Ö‡§™‡§®‡§æ ‡§¨‡•ã‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§™‡§æ‡§∏ ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç",
                get_pass: "‡§™‡§æ‡§∏ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç",
                help_center: "‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞",
            },
            pa: {
                route_map_link: "üó∫Ô∏è ‡®∞‡©Ç‡®ü ‡®¶‡®æ ‡®®‡®ï‡®∏‡®º‡®æ",
                punjab_bus_map_title: "‡®™‡©∞‡®ú‡®æ‡®¨ ‡®¨‡©±‡®∏ ‡®∞‡©Ç‡®ü ‡®¶‡®æ ‡®®‡®ï‡®∏‡®º‡®æ",
                chat_btn: "üí¨ ‡®ó‡©±‡®≤‡®¨‡®æ‡®§",
                main_title: "üöè ‡®∏‡®Æ‡®æ‡®∞‡®ü ‡®ü‡©ç‡®∞‡®æ‡®Ç‡®ú‡®º‡®ø‡®ü",
                main_subtitle: "‡®∞‡©Ä‡®Ö‡®≤-‡®ü‡®æ‡®à‡®Æ ‡®™‡®¨‡®≤‡®ø‡®ï ‡®ü‡©ç‡®∞‡®æ‡®Ç‡®∏‡®™‡©ã‡®∞‡®ü ‡®ü‡©ç‡®∞‡©à‡®ï‡®ø‡©∞‡®ó ‡®Ö‡®§‡©á ‡®∏‡®Æ‡®æ‡®∞‡®ü ‡®à‡®ü‡©Ä‡®è ‡®≠‡®µ‡®ø‡©±‡®ñ‡®¨‡®æ‡®£‡©Ä‡•§ ‡®∏‡®º‡®π‡®ø‡®∞‡©Ä ‡®ó‡®§‡©Ä‡®∏‡®º‡©Ä‡®≤‡®§‡®æ ‡®®‡©Ç‡©∞ ‡®ö‡©Å‡®∏‡®§, ‡®§‡©á‡®ú‡®º ‡®Ö‡®§‡©á ‡®µ‡®ß‡©á‡®∞‡©á ‡®≠‡®∞‡©ã‡®∏‡©á‡®Æ‡©∞‡®¶ ‡®¨‡®£‡®æ‡®â‡®£‡®æ‡•§",
                explore_app_btn: "‡®ê‡®™ ‡®¶‡©Ä ‡®™‡©ú‡®ö‡©ã‡®≤ ‡®ï‡®∞‡©ã",
                live_map_title: "üìç ‡®µ‡®æ‡®π‡®®‡®æ‡®Ç ‡®Ö‡®§‡©á ‡®¨‡©±‡®∏ ‡®Ö‡©±‡®°‡®ø‡®Ü‡®Ç ‡®¶‡©á ‡®®‡®æ‡®≤ ‡®≤‡®æ‡®à‡®µ ‡®®‡®ï‡®∏‡®º‡®æ",
                refresh_location_btn: "‡®Æ‡©á‡®∞‡®æ ‡®ü‡®ø‡®ï‡®æ‡®£‡®æ ‡®§‡®æ‡®ú‡®º‡®æ ‡®ï‡®∞‡©ã",
                where_is_my_bus_title: "üîç ‡®Æ‡©á‡®∞‡©Ä ‡®¨‡©±‡®∏ ‡®ï‡®ø‡©±‡®•‡©á ‡®π‡©à?",
                by_route_tab: "‡®∞‡©Ç‡®ü ‡®¶‡©Å‡®Ü‡®∞‡®æ",
                by_bus_number_tab: "‡®¨‡©±‡®∏ ‡®®‡©∞‡®¨‡®∞ ‡®¶‡©Å‡®Ü‡®∞‡®æ",
                from_label: "‡®§‡©ã‡®Ç",
                from_placeholder: "‡®â‡®¶‡®æ‡®π‡®∞‡®®, ‡®ï‡®°‡®ó‡®ø‡®≤",
                to_label: "‡®®‡©Ç‡©∞",
                to_placeholder: "‡®â‡®¶‡®æ‡®π‡®∞‡®®, ‡®§‡®∞‡®®‡®§‡®æ‡®∞‡®® ‡®¨‡©±‡®∏ ‡®∏‡®ü‡©à‡®Ç‡®°",
                find_buses_btn: "‡®¨‡©±‡®∏‡®æ‡®Ç ‡®≤‡©±‡®≠‡©ã",
                bus_number_label: "‡®¨‡©±‡®∏ ‡®®‡©∞‡®¨‡®∞",
                bus_number_placeholder: "‡®â‡®¶‡®æ‡®π‡®∞‡®®, 58",
                track_bus_btn: "‡®¨‡©±‡®∏ ‡®®‡©Ç‡©∞ ‡®ü‡®∞‡©à‡®ï ‡®ï‡®∞‡©ã",
                recent_searches_title: "‡®π‡®æ‡®≤‡©Ä‡®Ü ‡®ñ‡©ã‡®ú‡®æ‡®Ç",
                search_history_placeholder: "‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®ñ‡©ã‡®ú ‡®á‡®§‡®ø‡®π‡®æ‡®∏ ‡®á‡©±‡®•‡©á ‡®¶‡®ø‡®ñ‡®æ‡®à ‡®¶‡©á‡®µ‡©á‡®ó‡®æ‡•§",
                predictive_eta_title: "üß† ‡®≠‡®µ‡®ø‡©±‡®ñ‡®¨‡®æ‡®£‡©Ä ‡®à.‡®ü‡©Ä.‡®è.",
                start_location_label: "‡®∏‡®º‡©Å‡®∞‡©Ç‡®Ü‡®§‡©Ä ‡®∏‡®•‡®æ‡®®:",
                destination_label: "‡®Æ‡©∞‡®ú‡®º‡®ø‡®≤:",
                to_kashmere_placeholder: "‡®â‡®¶‡®æ‡®π‡®∞‡®®, ‡®§‡®∞‡®®‡®§‡®æ‡®∞‡®® ‡®¨‡©±‡®∏ ‡®∏‡®ü‡©à‡®Ç‡®°",
                predict_eta_btn: "‡®à‡®ü‡©Ä‡®è ‡®¶‡©Ä ‡®≠‡®µ‡®ø‡©±‡®ñ‡®¨‡®æ‡®£‡©Ä ‡®ï‡®∞‡©ã",
                prediction_placeholder: "‡®≠‡®µ‡®ø‡©±‡®ñ‡®¨‡®æ‡®£‡©Ä ‡®á‡©±‡®•‡©á ‡®¶‡®ø‡®ñ‡®æ‡®à ‡®¶‡©á‡®µ‡©á‡®ó‡©Ä...",
                route_planner_title: "üó∫ ‡®∏‡®Æ‡®æ‡®∞‡®ü ‡®∞‡©Ç‡®ü ‡®Ø‡©ã‡®ú‡®®‡®æ‡®ï‡®æ‡®∞",
                find_best_route_btn: "‡®µ‡®ß‡©Ä‡®Ü ‡®∞‡®∏‡®§‡®æ ‡®≤‡©±‡®≠‡©ã",
                route_reco_placeholder: "‡®∏‡®≠ ‡®§‡©ã‡®Ç ‡®µ‡®ß‡©Ä‡®Ü ‡®Ü‡®µ‡®æ‡®ú‡®æ‡®à ‡®µ‡®ø‡®ï‡®≤‡®™ ‡®¶‡©Ä ‡®∏‡®ø‡®´‡®º‡®æ‡®∞‡®∏‡®º ‡®™‡©ç‡®∞‡®æ‡®™‡®§ ‡®ï‡®∞‡®® ‡®≤‡®à ‡®∏‡®•‡®æ‡®® ‡®¶‡®æ‡®ñ‡®≤ ‡®ï‡®∞‡©ã‡•§",
                incident_report_title: "‚õì ‡®Ö‡®ü‡©±‡®≤ ‡®ò‡®ü‡®®‡®æ ‡®¶‡©Ä ‡®∞‡®ø‡®™‡©ã‡®∞‡®ü‡®ø‡©∞‡®ó",
                incident_placeholder: "‡®¶‡©á‡®∞‡©Ä, ‡®ü‡©Å‡©±‡®ü‡®£, ‡®ú‡®æ‡®Ç ‡®ò‡®ü‡®®‡®æ ‡®¶‡©Ä ‡®∞‡®ø‡®™‡©ã‡®∞‡®ü ‡®ï‡®∞‡©ã...",
                submit_report_btn: "‡®∞‡®ø‡®™‡©ã‡®∞‡®ü ‡®¶‡®∞‡®ú ‡®ï‡®∞‡©ã",
                chatbot_title: "‡®∏‡®º‡©ç‡®∞‡©Ä‡®Æ‡®æ‡®® ‡®ï‡©∞‡®°‡®ï‡®ü‡®∞",
                chatbot_placeholder: "‡®ï‡©Å‡®ù ‡®™‡©Å‡©±‡®õ‡©ã...",
                send_btn: "‡®≠‡©á‡®ú‡©ã",
                main_heading: "‡®≠‡®æ‡®∞‡®§ ‡®¶‡®æ ‡®®‡©∞‡®¨‡®∞ 1 ‡®¨‡©±‡®∏ ‡®ü‡®∞‡©à‡®ï‡®ø‡©∞‡®ó ‡®Ö‡®§‡©á ‡®¨‡©Å‡®ï‡®ø‡©∞‡®ó ‡®Ö‡®®‡©Å‡®≠‡®µ",
                main_subheading: "‡®∞‡©Ä‡®Ö‡®≤-‡®ü‡®æ‡®à‡®Æ ‡®µ‡®æ‡®π‡®® ‡®∏‡®•‡®æ‡®®, ‡®∏‡®Æ‡®æ‡®∞‡®ü ‡®à‡®ü‡©Ä‡®è ‡®≠‡®µ‡®ø‡©±‡®ñ‡®¨‡®æ‡®£‡©Ä‡®Ü‡®Ç ‡®Ö‡®§‡©á ‡®Ü‡®∏‡®æ‡®® ‡®∞‡©Ç‡®ü ‡®¶‡©Ä ‡®Ø‡©ã‡®ú‡®®‡®æ‡®¨‡©∞‡®¶‡©Ä - ‡®∏‡®≠ ‡®á‡©±‡®ï ‡®•‡®æ‡®Ç '‡®§‡©á‡•§",
                search_buses: "üîç ‡®¨‡©±‡®∏‡®æ‡®Ç ‡®¶‡©Ä ‡®ñ‡©ã‡®ú ‡®ï‡®∞‡©ã",
                festive_offer: "‡®§‡®ø‡®â‡®π‡®æ‡®∞‡®æ‡®Ç ‡®≤‡®à ‡®∞‡©á‡®≤ ‡®ó‡©±‡®°‡©Ä‡®Ü‡®Ç ‡®¨‡©Å‡©±‡®ï ‡®ï‡®∞‡©ã",
                offer_code: "FESTIVE ‡®ï‡©ã‡®° ‡®¶‡©Ä ‡®µ‡®∞‡®§‡©ã‡®Ç ‡®ï‡®∞‡®ï‡©á ‚Çπ100 ‡®¶‡©Ä ‡®õ‡©ã‡®ü ‡®™‡©ç‡®∞‡®æ‡®™‡®§ ‡®ï‡®∞‡©ã",
                punjab_bookings: "‡®™‡®ø‡®õ‡®≤‡©á ‡®Æ‡®π‡©Ä‡®®‡©á ‡®™‡©∞‡®ú‡®æ‡®¨ ‡®§‡©ã‡®Ç 25,000+ ‡®≤‡©ã‡®ï‡®æ‡®Ç ‡®®‡©á ‡®¨‡©Å‡©±‡®ï ‡®ï‡©Ä‡®§‡®æ",
                refresh_vehicles_btn: "‡®µ‡®æ‡®π‡®® ‡®§‡®æ‡®ú‡®º‡®æ ‡®ï‡®∞‡©ã",
                footer_text: "‚ù§ ‡®®‡®æ‡®≤ ‡®¨‡®£‡®æ‡®á‡®Ü ‡®ó‡®ø‡®Ü ‚Äî ‡®∏‡®Æ‡®æ‡®∞‡®ü ‡®ü‡©ç‡®∞‡®æ‡®Ç‡®ú‡®º‡®ø‡®ü ‡®™‡©ç‡®∞‡©ã‡®ü‡©ã‡®ü‡®æ‡®à‡®™",
                confirm_boarding_pass: "‡®Ü‡®™‡®£‡©á ‡®¨‡©ã‡®∞‡®°‡®ø‡©∞‡®ó ‡®™‡®æ‡®∏ ‡®¶‡©Ä ‡®™‡©Å‡®∏‡®º‡®ü‡©Ä ‡®ï‡®∞‡©ã",
                get_pass: "‡®™‡®æ‡®∏ ‡®™‡©ç‡®∞‡®æ‡®™‡®§ ‡®ï‡®∞‡©ã",
                help_center: "‡®∏‡®π‡®æ‡®á‡®§‡®æ ‡®ï‡©á‡®Ç‡®¶‡®∞",
            }
        };

        function setLanguage(lang) {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.innerText = translations[lang][key];
                    }
                }
            });
        }
        
        document.getElementById('language-selector').addEventListener('change', (event) => {
            setLanguage(event.target.value);
        });

        const gtfsStops = {};
        const gtfsRoutes = [];
        const gtfsBuses = [];

        function loadBusData() {
            const jsonData = {
                "58": [
                    {"stop_id": 5801, "stop_name": "Kadgil", "lat": 31.4581, "lon": 74.9252, "arrival_time": "08:00:00", "departure_time": "08:00:00"},
                    {"stop_id": 5802, "stop_name": "Baghrian", "lat": 31.4709, "lon": 74.9402, "arrival_time": "08:10:00", "departure_time": "08:10:00"},
                    {"stop_id": 5803, "stop_name": "Jalal", "lat": 31.4821, "lon": 74.9605, "arrival_time": "08:18:00", "departure_time": "08:18:00"},
                    {"stop_id": 5804, "stop_name": "Hakam Singh Wala", "lat": 31.4938, "lon": 74.9756, "arrival_time": "08:25:00", "departure_time": "08:25:00"},
                    {"stop_id": 5805, "stop_name": "Tarn Taran Bus Stand", "lat": 31.4512, "lon": 74.9271, "arrival_time": "08:40:00", "departure_time": "08:40:00"}
                ],
                "60": [
                    {"stop_id": 6001, "stop_name": "Bathinda Bus Stand", "lat": 30.2110, "lon": 74.9455, "arrival_time": "09:00:00", "departure_time": "09:00:00"},
                    {"stop_id": 6002, "stop_name": "Talwandi Sabo Road Crossing", "lat": 30.2364, "lon": 75.0462, "arrival_time": "09:12:00", "departure_time": "09:12:00"},
                    {"stop_id": 6003, "stop_name": "Gill Khooh", "lat": 30.2529, "lon": 75.0658, "arrival_time": "09:20:00", "departure_time": "09:20:00"},
                    {"stop_id": 6004, "stop_name": "Takhat Sahib", "lat": 30.2598, "lon": 75.0783, "arrival_time": "09:28:00", "departure_time": "09:28:00"},
                    {"stop_id": 6005, "stop_name": "Talwandi Sabo Bus Stand", "lat": 30.2611, "lon": 75.0867, "arrival_time": "09:35:00", "departure_time": "09:35:00"}
                ],
                "65": [
                    {"stop_id": 6501, "stop_name": "Raman Mandi", "lat": 29.9694, "lon": 75.1011, "arrival_time": "10:00:00", "departure_time": "10:00:00"},
                    {"stop_id": 6502, "stop_name": "Jassi Baghwali", "lat": 29.9810, "lon": 75.1211, "arrival_time": "10:08:00", "departure_time": "10:08:00"},
                    {"stop_id": 6503, "stop_name": "Ganga Village", "lat": 29.9948, "lon": 75.1455, "arrival_time": "10:16:00", "departure_time": "10:16:00"},
                    {"stop_id": 6504, "stop_name": "Ramsara", "lat": 30.0055, "lon": 75.1687, "arrival_time": "10:25:00", "departure_time": "10:25:00"}
                ]
            };
            for (const routeId in jsonData) {
                const routeData = jsonData[routeId];
                if (routeData.length > 0) {
                    const routeStops = [];
                    routeData.forEach(stop => {
                        const stopKey = `s${stop.stop_id}`;
                        if (!gtfsStops[stopKey]) {
                            gtfsStops[stopKey] = {
                                name: stop.stop_name,
                                lat: stop.lat,
                                lon: stop.lon
                            };
                        }
                        routeStops.push({ stopId: stopKey, arrival_time: stop.arrival_time, departure_time: stop.departure_time });
                    });

                    gtfsRoutes.push({
                        id: routeId,
                        name: `${routeData[0].stop_name} to ${routeData[routeData.length - 1].stop_name}`,
                        schedule: routeStops
                    });

                    // Simulate some buses for each route
                    for (let i = 0; i < 2; i++) {
                        gtfsBuses.push({
                            id: `PB03N${Math.floor(Math.random() * 9000) + 1000}`,
                            routeId: routeId,
                            currentStopIndex: Math.floor(Math.random() * routeStops.length),
                        });
                    }
                }
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => initMap(pos.coords.latitude, pos.coords.longitude), () => initMap());
            } else initMap();
            // simulateBusMovement(); // disabled to prefer live Firestore updates
        }
        
        let map, userMarker, db;
        let vehicleMarkers = [];
        let reportChain = [];

        function initMap(lat = 30.90, lng = 75.85) { // Default coordinates for Punjab (Ludhiana)
            map = L.map('map').setView([lat, lng], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data ¬© OpenStreetMap contributors'
            }).addTo(map);
            userMarker = L.marker([lat, lng], { icon: new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            }) }).addTo(map).bindPopup('You are here').openPopup();
            updateVehicleMarkers();
        }

        function updateVehicleMarkers() {
            vehicleMarkers.forEach(m => map.removeLayer(m));
            vehicleMarkers = [];
            gtfsBuses.forEach(bus => {
                const route = gtfsRoutes.find(r => r.id === bus.routeId);
                if (!route || !route.schedule[bus.currentStopIndex]) return;
                const stopInfo = route.schedule[bus.currentStopIndex];
                const stop = gtfsStops[stopInfo.stopId];
                
                let lat = stop.lat;
                let lon = stop.lon;
                if (bus.currentStopIndex + 1 < route.schedule.length) {
                    const nextStop = gtfsStops[route.schedule[bus.currentStopIndex + 1].stopId];
                    lat = stop.lat + (nextStop.lat - stop.lat) * 0.5;
                    lon = stop.lon + (nextStop.lon - stop.lon) * 0.5;
                }
                
                const marker = L.marker([lat, lon], { icon: new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }) }).addTo(map)
                    .bindPopup(`<strong>Bus:</strong> ${bus.id}<br/><strong>Route:</strong> ${route.id}<br/><strong>Next Stop:</strong> ${stop.name}`);
                vehicleMarkers.push(marker);
            });
        }

        function refreshLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude, lng = pos.coords.longitude;
                    userMarker.setLatLng([lat, lng]).bindPopup('You are here').openPopup();
                    map.setView([lat, lng], 14, { animate: true });
                }, () => alert('Location not available. Using default location.'));
            }
        }

        function calculatePredictiveETA() {
            const start = document.getElementById('etaStartLocation').value.trim();
            const end = document.getElementById('etaEndLocation').value.trim();
            const resultEl = document.getElementById('predictiveEtaResult');

            if (!start || !end) {
                resultEl.innerHTML = `<p class="text-red-600">Please enter a start and end location.</p>`;
                return;
            }

            const route = gtfsRoutes.find(r => {
                const startIndex = r.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(start.toLowerCase()));
                const endIndex = r.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(end.toLowerCase()));
                return startIndex !== -1 && endIndex !== -1 && startIndex < endIndex;
            });

            if (!route) {
                resultEl.innerHTML = `<p class="text-red-600">No direct bus route found for this journey.</p>`;
                return;
            }

            const startIndex = route.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(start.toLowerCase()));
            const endIndex = route.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(end.toLowerCase()));
            
            const numStops = endIndex - startIndex;
            const baseTimePerStop = 3; 
            const scheduledDuration = numStops * baseTimePerStop;
            
            // Assume an average traffic level for calculation instead of user input
            const AVERAGE_TRAFFIC_FACTOR = 5; // Simulating average traffic on a scale of 1-10
            const trafficDelay = numStops * (AVERAGE_TRAFFIC_FACTOR * 0.25); 
            const predictedEta = scheduledDuration + trafficDelay;

            resultEl.innerHTML = `
                <p><strong>Stops to travel:</strong> ${numStops}</p>
                <p><strong>Predicted ETA (avg. traffic):</strong> ${predictedEta.toFixed(1)} minutes</p>
                <p class="text-sm text-gray-600">On route: ${route.name}</p>
            `;
        }

        function findBestRoute() {
            const start = document.getElementById('startLocationPlanner').value.trim();
            const end = document.getElementById('endLocationPlanner').value.trim();
            const resultEl = document.getElementById('routeRecommendation');

            if (!start || !end) { 
                resultEl.innerHTML = `<p class="text-red-600">Please enter start and destination.</p>`;
                return; 
            }

            const matchingRoutes = gtfsRoutes.filter(route => {
                const startIndex = route.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(start.toLowerCase()));
                const endIndex = route.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(end.toLowerCase()));
                return startIndex !== -1 && endIndex !== -1 && startIndex < endIndex;
            });
            
            if (matchingRoutes.length > 0) {
                    let recommendations = matchingRoutes.map(route => {
                            return `<div class="mb-2">
                                        <p>üöÄ <strong>Best Option: Bus</strong></p>
                                        <p><strong>Route:</strong> ${route.name} (${route.id})</p>
                                    </div>`;
            }).join('');
                resultEl.innerHTML = recommendations;
            } else {
                resultEl.innerHTML = `
                    <p>No direct bus route found.</p>
                    <p class="text-sm text-gray-600">Consider alternative transport like Auto or Metro.</p>
                `;
            }
        }

        function submitImmutableReport() {
            const report = document.getElementById('reportInput').value.trim();
            if (!report) { alert('Enter report'); return; }
            const prev = reportChain.length ? reportChain[reportChain.length - 1].hash : 'GENESIS';
            const ts = new Date().toISOString();
            const hash = CryptoJS.SHA256(`${prev}|${ts}|${report}`).toString();
            reportChain.push({ previousHash: prev, timestamp: ts, report, hash });
            displayReportChain();
            document.getElementById('reportInput').value = '';
        }

        function displayReportChain() {
            document.getElementById('reportChain').innerHTML = reportChain.map(b => `
                <div class="p-2 bg-white rounded shadow mb-2">
                    <p><strong>Timestamp:</strong> ${b.timestamp}</p>
                    <p><strong>Report:</strong> ${b.report}</p>
                    <p><strong>Hash:</strong> ${b.hash.substring(0,20)}...</p>
                    <p><strong>Previous Hash:</strong> ${b.previousHash.substring(0,20)}...</p>
                </div>`).join('');
        }
        
        const tabRoute = document.getElementById('tab-route');
        const tabNumber = document.getElementById('tab-number');
        const formRoute = document.getElementById('form-route');
        const formNumber = document.getElementById('form-number');
        const resultsDiv = document.getElementById('results');
        const historyListDiv = document.getElementById('history-list');
        let userId;

        function switchTab(tab) {
            if (tab === 'route') {
                tabRoute.classList.add('bg-white', 'text-blue-600', 'shadow');
                tabNumber.classList.remove('bg-white', 'text-blue-600', 'shadow');
                formRoute.classList.remove('hidden');
                formNumber.classList.add('hidden');
            } else {
                tabNumber.classList.add('bg-white', 'text-blue-600', 'shadow');
                tabRoute.classList.remove('bg-white', 'text-blue-600', 'shadow');
                formNumber.classList.remove('hidden');
                formRoute.classList.add('hidden');
            }
        }

        function generateTimelineHtml(bus, route) {
            if (!bus || !route) return '';
            return route.schedule.map((stopInfo, index) => {
                const stop = gtfsStops[stopInfo.stopId];
                const isPast = index < bus.currentStopIndex;
                const isCurrent = index === bus.currentStopIndex;
                let dotClass = isPast ? 'bg-green-500' : (isCurrent ? 'bg-blue-500 ring-4 ring-blue-200' : 'bg-gray-300');
                let textClass = isPast ? 'text-gray-500 line-through' : (isCurrent ? 'text-blue-700 font-bold' : 'text-gray-800');
                let timeStatus = isPast ? `Departed at ${stopInfo.departure_time}` : (isCurrent ? `Arrived at ${stopInfo.arrival_time}` : `Expected at ${stopInfo.arrival_time}`);

                return `<div class="timeline-item relative pl-10 pb-10">
                            <div class="timeline-dot absolute w-5 h-5 rounded-full ${dotClass}">
                                ${isCurrent ? '<svg class="bus-icon text-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5-1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>' : ''}
                            </div>
                            <div class="${textClass}"><p class="font-medium">${stop.name}</p><p class="text-sm"><span class="text-xs ml-2">${timeStatus}</span></p></div>
                        </div>`;
            }).join('');
        }

        function findBusesByRoute(start, end) {
            let matchingRoutes = gtfsRoutes.filter(route => {
                const startIndex = route.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(start.toLowerCase()));
                const endIndex = route.schedule.findIndex(s => gtfsStops[s.stopId].name.toLowerCase().includes(end.toLowerCase()));
                return startIndex !== -1 && endIndex !== -1 && startIndex < endIndex;
            });

            let busesToDisplay = [];
            matchingRoutes.forEach(route => {
                const busesOnRoute = gtfsBuses.filter(bus => bus.routeId === route.id);
                busesToDisplay.push(...busesOnRoute);
            });
            
            if (busesToDisplay.length === 0) {
                resultsDiv.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">No direct buses found for this route.</p>`;
                return;
            }

            let html = busesToDisplay.map(bus => {
                const route = gtfsRoutes.find(r => r.id === bus.routeId);
                const timelineHtml = generateTimelineHtml(bus, route);

                return `<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4 pb-4 border-b">
                                <div>
                                    <p class="font-bold text-xl text-blue-700">Bus Number: ${bus.id}</p>
                                    <p class="text-md text-gray-600">Route: ${route.name}</p>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-4 text-gray-800">Live Status & Route</h4>
                                ${timelineHtml}
                            </div>
                        </div>`;
            }).join('');
            
            html += `
                <div class="mt-6 text-center">
                    <button id="bookRouteTicketBtn" data-start="${start}" data-end="${end}" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition text-lg">
                        Get Boarding Pass for this Route
                    </button>
                </div>
            `;

            resultsDiv.innerHTML = html;
            saveSearchHistory({ type: 'route', start, end });
        }

        function findBusByNumber(busId) {
            const route = gtfsRoutes.find(r => r.id.toLowerCase() === busId.toLowerCase());
            if (!route) {
                resultsDiv.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">Route number not found.</p>`;
                return;
            }
            
            const busesOnRoute = gtfsBuses.filter(b => b.routeId === route.id);
            if(busesOnRoute.length === 0){
                resultsDiv.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">No active buses found on this route right now.</p>`;
                return;
            }

            let html = busesOnRoute.map(bus => {
                const timelineHtml = generateTimelineHtml(bus, route);
                return `<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4 pb-4 border-b">
                                <div>
                                    <p class="font-bold text-xl text-blue-700">Bus: ${bus.id}</p>
                                    <p class="text-md text-gray-600">On Route ${route.name} (${route.id})</p>
                                </div>
                            </div>
                            <div>${timelineHtml}</div>
                        </div>`;
            }).join('');
            resultsDiv.innerHTML = html;
            saveSearchHistory({ type: 'number', number: busId });
        }
        
        async function saveSearchHistory(query) {
                if (!userId || !db) return;
                try {
                    const historyCollection = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default'}/users/${userId}/searchHistory`);
                    await addDoc(historyCollection, { ...query, timestamp: new Date() });
                } catch (error) { console.error("Error saving history: ", error); }
        }

        function loadSearchHistory() {
                if (!userId || !db) return;
                const historyCollection = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default'}/users/${userId}/searchHistory`);
                const q = query(historyCollection, orderBy('timestamp', 'desc'), limit(5));
                onSnapshot(q, (snapshot) => {
                        if (snapshot.empty) {
                            historyListDiv.innerHTML = `<p class="text-center text-gray-500 text-sm" data-translate="search_history_placeholder">Your search history will appear here.</p>`;
                            return;
                        }
                        let historyHtml = '';
                        const uniqueSearches = new Map();
                        snapshot.docs.forEach(doc => {
                            const data = doc.data();
                            const key = data.type === 'route' ? `route-${data.start}-${data.end}` : `number-${data.number}`;
                            if (!uniqueSearches.has(key)) uniqueSearches.set(key, data);
                        });
                        uniqueSearches.forEach(data => {
                            if (data.type === 'route') {
                                    historyHtml += `<div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between cursor-pointer history-item" data-type="route" data-start="${data.start}" data-end="${data.end}"><div><p class="font-medium text-sm">${data.start} ‚Üí ${data.end}</p><p class="text-xs text-gray-500">Route Search</p></div><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>`;
                            } else {
                                    historyHtml += `<div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between cursor-pointer history-item" data-type="number" data-number="${data.number}"><div><p class="font-medium text-sm">Route ${data.number}</p><p class="text-xs text-gray-500">Route Number Search</p></div><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>`;
                            }
                        });
                        historyListDiv.innerHTML = historyHtml;
                });
        }
        
        function handleHistoryClick(e) {
            const item = e.target.closest('.history-item');
            if (!item) return;
            const { type, start, end, number } = item.dataset;
            if (type === 'route') {
                document.getElementById('start-point').value = start;
                document.getElementById('destination').value = end;
                switchTab('route');
                findBusesByRoute(start, end);
            } else {
                document.getElementById('bus-number').value = number;
                switchTab('number');
                findBusByNumber(number);
            }
                window.scrollTo({ top: document.getElementById('mainContent').offsetTop, behavior: 'smooth' });
        }

        function simulateBusMovement() {
            setInterval(() => {
                gtfsBuses.forEach(bus => {
                    const route = gtfsRoutes.find(r => r.id === bus.routeId);
                    if (route) {
                        bus.currentStopIndex = (bus.currentStopIndex + 1) % route.schedule.length;
                    }
                });
                if(map) {
                    updateVehicleMarkers();
                }
            }, 15000);
        }
        
        function toggleChatbot() {
            document.getElementById('chatbot-modal').classList.toggle('hidden');
        }

        async function handleChat() {
            const inputEl = document.getElementById('chat-input');
            const outputEl = document.getElementById('chat-output');
            const userMessage = inputEl.value.trim();
            if (!userMessage) return;

            outputEl.innerHTML += `<div class="text-right text-blue-800 my-1"><strong>You:</strong> ${userMessage}</div>`;
            inputEl.value = '';
            outputEl.scrollTop = outputEl.scrollHeight;

            const thinkingEl = document.createElement('div');
            thinkingEl.classList.add('text-left', 'text-gray-800', 'my-1');
            thinkingEl.innerHTML = `<strong>Mr. Conductor:</strong> Thinking...`;
            outputEl.appendChild(thinkingEl);
            outputEl.scrollTop = outputEl.scrollHeight;
            
            const systemPrompt = `You are Mr. Conductor, a friendly and helpful bus transit assistant for the Punjab area. Your goal is to answer user questions about bus routes, stops, and schedules. You must ONLY use the data provided below to answer questions. If the information is not in the data, say you don't have that information. Do not make anything up. Also handle basic greetings and tasks.

            Here is the available bus data:
            Stops: ${JSON.stringify(gtfsStops)}
            Routes and Schedules: ${JSON.stringify(gtfsRoutes)}
            Live Bus Locations: ${JSON.stringify(gtfsBuses)}
            `;

            const apiKey = ""; // Chat disabled: no API key
            if (!apiKey) {
                thinkingEl.innerHTML = `<strong>Mr. Conductor:</strong> Sorry, my API key is missing. The developer needs to add it to the script.`;
                outputEl.scrollTop = outputEl.scrollHeight;
                return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent`;

            const payload = {
                contents: [
                    { role: 'user', parts: [{ text: `${systemPrompt}\n\nUser: ${userMessage}` }] }
                ]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errText = await response.text().catch(()=> '');
                    throw new Error(`API request failed ${response.status}: ${errText}`);
                }
                const result = await response.json();
                
                let botReply = "Sorry, I had trouble finding an answer. Please try again.";
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                    botReply = result.candidates[0].content.parts[0].text;
                }
                thinkingEl.innerHTML = `<strong>Mr. Conductor:</strong> ${botReply}`;

            } catch(error) {
                console.error("Chat API Error:", error);
                thinkingEl.innerHTML = `<strong>Mr. Conductor:</strong> Sorry, I'm having trouble connecting right now. Please check the API key and try again.`;
            }

            outputEl.scrollTop = outputEl.scrollHeight;
        }
        
        function generateRouteMap() {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.getElementById('routeMapSvg');
            const legend = document.getElementById('routeMapLegend');
            svg.innerHTML = '';
            legend.innerHTML = '';

            const routeColors = { '58': '#e50025', '60': '#0057e7', '65': '#50C878' };
            const stopPositions = {}; // Tracks the first drawn position of any stop { stopId: {x, y, routeColor} }
            const allElementsGroup = document.createElementNS(svgNS, 'g');
            svg.appendChild(allElementsGroup);

            let currentX = 150; // Start X for the first route column
            const routesToDisplay = gtfsRoutes.slice(0, 4); 

            routesToDisplay.forEach(route => {
                legend.innerHTML += `<div class="flex items-center"><span class="w-4 h-4 mr-2 rounded-sm" style="background-color: ${routeColors[route.id] || '#333'};"></span><span class="font-semibold text-sm">${route.name} (${route.id})</span></div>`;
            });

            routesToDisplay.forEach(route => {
                const routeColor = routeColors[route.id] || '#333';
                const routeGroup = document.createElementNS(svgNS, 'g');
                allElementsGroup.appendChild(routeGroup);

                let currentY = 100;
                const firstStopY = currentY;

                const mainLine = document.createElementNS(svgNS, 'line');
                mainLine.setAttribute('x1', currentX);
                mainLine.setAttribute('y1', firstStopY);
                mainLine.setAttribute('x2', currentX);
                const lastStopY = firstStopY + (route.schedule.length - 1) * 80;
                mainLine.setAttribute('y2', lastStopY);
                mainLine.setAttribute('stroke', routeColor);
                mainLine.setAttribute('stroke-width', 6);
                mainLine.setAttribute('stroke-linecap', 'round');
                routeGroup.appendChild(mainLine);

                route.schedule.forEach(stopInfo => {
                    const stopId = stopInfo.stopId;
                    const stop = gtfsStops[stopId];

                    if (!stopPositions[stopId]) { 
                        stopPositions[stopId] = { x: currentX, y: currentY, routeColor: routeColor };

                        const circle = document.createElementNS(svgNS, 'circle');
                        circle.setAttribute('cx', currentX);
                        circle.setAttribute('cy', currentY);
                        circle.setAttribute('r', 8);
                        circle.setAttribute('fill', 'white');
                        circle.setAttribute('stroke', routeColor);
                        circle.setAttribute('stroke-width', 4);
                        routeGroup.appendChild(circle);

                        const text = document.createElementNS(svgNS, 'text');
                        text.setAttribute('x', currentX + 20);
                        text.setAttribute('y', currentY);
                        text.setAttribute('dy', '.35em');
                        text.setAttribute('font-size', '14');
                        text.setAttribute('font-family', 'sans-serif');
                        text.textContent = stop.name;
                        routeGroup.appendChild(text);

                    } else { 
                        const originalPos = stopPositions[stopId];

                        const connectorLine = document.createElementNS(svgNS, 'line');
                        connectorLine.setAttribute('x1', currentX);
                        connectorLine.setAttribute('y1', currentY);
                        connectorLine.setAttribute('x2', originalPos.x);
                        connectorLine.setAttribute('y2', originalPos.y);
                        connectorLine.setAttribute('stroke', '#888');
                        connectorLine.setAttribute('stroke-width', 2);
                        connectorLine.setAttribute('stroke-dasharray', '5,5');
                        routeGroup.insertBefore(connectorLine, routeGroup.firstChild);

                        const smallDot = document.createElementNS(svgNS, 'circle');
                        smallDot.setAttribute('cx', currentX);
                        smallDot.setAttribute('cy', currentY);
                        smallDot.setAttribute('r', 5);
                        smallDot.setAttribute('fill', routeColor);
                        routeGroup.appendChild(smallDot);
                        
                        const originalCircle = allElementsGroup.querySelector(`circle[cx='${originalPos.x}'][cy='${originalPos.y}']`);
                         if(originalCircle) {
                           originalCircle.setAttribute('r', 10);
                           originalCircle.setAttribute('stroke', '#000');
                           originalCircle.setAttribute('fill', 'white');
                         }
                    }
                    currentY += 80;
                });
                currentX += 250; 
            });

            try {
                const padding = 50;
                const bbox = allElementsGroup.getBBox();
                svg.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding*2} ${bbox.height + padding*2}`);
            } catch (e) {
                console.error("Could not get BBox of SVG, map might not display correctly.", e);
            }

            let isPanning = false, startPoint = {x: 0, y: 0}, viewBox = svg.viewBox.baseVal;
            const getPoint = (e) => {
                const CTM = svg.getScreenCTM();
                let clientX = e.clientX || (e.touches && e.touches[0].clientX);
                let clientY = e.clientY || (e.touches && e.touches[0].clientY);
                return { x: (clientX - CTM.e) / CTM.a, y: (clientY - CTM.f) / CTM.d };
            };
            const startPan = (e) => {
                isPanning = true;
                startPoint = { x: e.clientX || (e.touches && e.touches[0].clientX), y: e.clientY || (e.touches && e.touches[0].clientY) };
                svg.style.cursor = 'grabbing';
            };
            const doPan = (e) => {
                if (!isPanning) return;
                let clientX = e.clientX || (e.touches && e.touches[0].clientX);
                let clientY = e.clientY || (e.touches && e.touches[0].clientY);
                let dx = (startPoint.x - clientX) * (viewBox.width / svg.clientWidth);
                let dy = (startPoint.y - clientY) * (viewBox.height / svg.clientHeight);
                viewBox.x += dx;
                viewBox.y += dy;
                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
                startPoint = { x: clientX, y: clientY };
            };
            const stopPan = () => { if (isPanning) { isPanning = false; svg.style.cursor = 'grab'; }};
            svg.addEventListener('mousedown', startPan);
            svg.addEventListener('mousemove', doPan);
            svg.addEventListener('mouseup', stopPan);
            svg.addEventListener('mouseleave', stopPan);
            svg.addEventListener('touchstart', startPan);
            svg.addEventListener('touchmove', doPan);
            svg.addEventListener('touchend', stopPan);

            svg.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomIntensity = 0.1;
                const { x, y } = getPoint(e);
                const dw = viewBox.width * Math.sign(e.deltaY) * zoomIntensity;
                const dh = viewBox.height * Math.sign(e.deltaY) * zoomIntensity;
                if ((viewBox.width - dw) < 100 || (viewBox.height - dh) < 100) return;
                viewBox.x += dw * (x - viewBox.x) / viewBox.width;
                viewBox.y += dh * (y - viewBox.y) / viewBox.height;
                viewBox.width -= dw;
                viewBox.height -= dh;
                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
            });
        }
        
        window.toggleChatbot = toggleChatbot;
        window.refreshLocation = refreshLocation;
        window.calculatePredictiveETA = calculatePredictiveETA;
        window.findBestRoute = findBestRoute;
        window.submitImmutableReport = submitImmutableReport;
        window.handleChat = handleChat;
        
        try {
            const firebaseConfig = {
                apiKey: "  ",
                authDomain: "real-time-bus-tracking-fd181.firebaseapp.com",
                projectId: "real-time-bus-tracking-fd181",
                storageBucket: "real-time-bus-tracking-fd181.firebasestorage.app",
                messagingSenderId: "1069445545601",
                appId: "1:1069445545601:web:998fb578ee8dc375695780",
                measurementId: "G-0B2W32N0RY"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);
            window.__firebase_initialized = true;
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    loadSearchHistory();
                }
            });

            // Remove forced anonymous sign-in to avoid admin-restricted-operation.
            // Let users sign in via the User Login modal instead.

        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        tabRoute.addEventListener('click', () => switchTab('route'));
        tabNumber.addEventListener('click', () => switchTab('number'));
        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const from = document.getElementById('fromInput').value.trim();
            const to = document.getElementById('toInput').value.trim();
            const resultsSection = document.getElementById('mainContent');
            if (!from || !to) return;
            findBusesByRoute(from, to);
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        });
        formRoute.addEventListener('submit', (e) => { e.preventDefault(); findBusesByRoute(document.getElementById('start-point').value.trim(), document.getElementById('destination').value.trim()); });
        formNumber.addEventListener('submit', (e) => { e.preventDefault(); findBusByNumber(document.getElementById('bus-number').value.trim()); });
        
        resultsDiv.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'bookRouteTicketBtn') {
                const start = e.target.dataset.start;
                const end = e.target.dataset.end;
                openBoardingPassModal(start, end);
            }
        });
        historyListDiv.addEventListener('click', handleHistoryClick);

        const routeMapModal = document.getElementById('routeMapModal');
        document.getElementById('routeMapLink').addEventListener('click', (e) => {
            e.preventDefault();
            routeMapModal.classList.remove('hidden');
            generateRouteMap();
        });
        document.getElementById('closeMapBtn').addEventListener('click', () => {
            routeMapModal.classList.add('hidden');
        });

        // Booking Modal
        const bookingModal = document.getElementById('bookingModal');
        const closeBookingModal = document.getElementById('closeBookingModal');
        const confirmBooking = document.getElementById('confirmBooking');
        const bookingsDetailsModal = document.getElementById('bookingsDetailsModal');

        function openBoardingPassModal(start, end) {
            const detailsDiv = document.getElementById('boarding-pass-details');
            detailsDiv.innerHTML = `
                <p class="text-gray-800">You are about to book a universal boarding pass for the route:</p>
                <p class="text-xl font-bold my-2 text-indigo-600">${start} &rarr; ${end}</p>
                <p class="text-sm text-gray-600">This pass is valid for any bus operating on this route for today.</p>
            `;
            // Store details for the confirm button
            confirmBooking.dataset.start = start;
            confirmBooking.dataset.end = end;
            bookingModal.classList.remove('hidden');
        }
        
        closeBookingModal.addEventListener('click', () => {
            bookingModal.classList.add('hidden');
        });

        confirmBooking.addEventListener('click', (e) => {
            const start = e.target.dataset.start;
            const end = e.target.dataset.end;
            const booking = { start, end, date: new Date().toISOString().split('T')[0], passType: 'General Boarding' };
            const curr = JSON.parse(localStorage.getItem('st_bookings') || '[]');
            curr.unshift(booking);
            localStorage.setItem('st_bookings', JSON.stringify(curr.slice(0, 10)));
            alert(`Boarding pass confirmed for the route: ${start} to ${end}.\n\nThis pass can be used on any bus on this route.`);
            bookingModal.classList.add('hidden');
        });

        document.getElementById('bookingsLink').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('bookingsDropdown').classList.toggle('hidden');
        });

        document.getElementById('accountBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('accountDropdown').classList.toggle('hidden');
        });
        
        // Account: inject Profile & Settings modals and wire dropdown actions
        (function injectAccountModals(){
            // Profile modal
            const profileWrap = document.createElement('div');
            profileWrap.id = 'profileModal';
            profileWrap.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[6000] ui-overlay';
            profileWrap.innerHTML = `
                <div class=\"bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative\">
                    <button id=\"closeProfileModal\" class=\"absolute top-3 right-4 text-2xl text-gray-500 hover:text-black\">&times;</button>
                    <h3 class=\"text-xl font-bold mb-4 text-gray-800\">My Profile</h3>
                    <div class=\"space-y-3\">
                        <input id=\"profileName\" class=\"w-full border rounded px-3 py-2\" placeholder=\"Display Name\" />
                        <input id=\"profileEmail\" class=\"w-full border rounded px-3 py-2\" placeholder=\"Email\" type=\"email\" />
                        <button id=\"saveProfileBtn\" class=\"w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700\">Save</button>
                    </div>
                    <p id=\"profileStatus\" class=\"text-sm text-gray-600 mt-3\"></p>
                </div>
            `;
            document.body.appendChild(profileWrap);
            profileWrap.querySelector('#closeProfileModal').addEventListener('click', ()=> profileWrap.classList.add('hidden'));
            profileWrap.querySelector('#saveProfileBtn').addEventListener('click', ()=>{
                const name = profileWrap.querySelector('#profileName').value.trim();
                const email = profileWrap.querySelector('#profileEmail').value.trim();
                try {
                    localStorage.setItem('st_profile_name', name);
                    localStorage.setItem('st_profile_email', email);
                    profileWrap.querySelector('#profileStatus').textContent = 'Saved.';
                } catch(e){ profileWrap.querySelector('#profileStatus').textContent = 'Could not save.'; }
            });

            // Settings modal
            const settingsWrap = document.createElement('div');
            settingsWrap.id = 'settingsModal';
            settingsWrap.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[6000] ui-overlay';
            settingsWrap.innerHTML = `
                <div class=\"bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative\">
                    <button id=\"closeSettingsModal\" class=\"absolute top-3 right-4 text-2xl text-gray-500 hover:text-black\">&times;</button>
                    <h3 class=\"text-xl font-bold mb-4 text-gray-800\">Settings</h3>
                    <div class=\"space-y-4\">
                        <div>
                            <label class=\"block text-sm font-medium text-gray-700 mb-1\">Language</label>
                            <select id=\"settingsLanguage\" class=\"w-full border rounded px-3 py-2\">
                                <option value=\"en\">English</option>
                                <option value=\"hi\">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                                <option value=\"pa\">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
                            </select>
                        </div>
                        <button id=\"saveSettingsBtn\" class=\"w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700\">Save</button>
                    </div>
                    <p id=\"settingsStatus\" class=\"text-sm text-gray-600 mt-3\"></p>
                </div>
            `;
            document.body.appendChild(settingsWrap);
            settingsWrap.querySelector('#closeSettingsModal').addEventListener('click', ()=> settingsWrap.classList.add('hidden'));
            settingsWrap.querySelector('#saveSettingsBtn').addEventListener('click', ()=>{
                const lang = settingsWrap.querySelector('#settingsLanguage').value;
                try {
                    localStorage.setItem('st_language', lang);
                    document.getElementById('language-selector').value = lang;
                    setLanguage(lang);
                    settingsWrap.querySelector('#settingsStatus').textContent = 'Saved.';
                } catch(e){ settingsWrap.querySelector('#settingsStatus').textContent = 'Could not save.'; }
            });

            // Prefill modals when opened
            function openProfile(){
                profileWrap.querySelector('#profileName').value = localStorage.getItem('st_profile_name') || '';
                profileWrap.querySelector('#profileEmail').value = localStorage.getItem('st_profile_email') || '';
                profileWrap.querySelector('#profileStatus').textContent = '';
                profileWrap.classList.remove('hidden');
            }
            function openSettings(){
                const lang = localStorage.getItem('st_language') || document.getElementById('language-selector').value || 'en';
                settingsWrap.querySelector('#settingsLanguage').value = lang;
                settingsWrap.querySelector('#settingsStatus').textContent = '';
                settingsWrap.classList.remove('hidden');
            }

            // Wire dropdown items
            const accountDropdown = document.getElementById('accountDropdown');
            if (accountDropdown){
                const links = accountDropdown.querySelectorAll('a');
                // Assumes ordering: My Profile, Settings, Logout
                if (links[0]) links[0].addEventListener('click', (e)=>{ e.preventDefault(); accountDropdown.classList.add('hidden'); openProfile(); });
                if (links[1]) links[1].addEventListener('click', (e)=>{ e.preventDefault(); accountDropdown.classList.add('hidden'); openSettings(); });
                if (links[2]) links[2].addEventListener('click', async (e)=>{ 
                    e.preventDefault(); accountDropdown.classList.add('hidden');
                    try { await (window.firebaseAuthLogout ? window.firebaseAuthLogout() : userLogout()); } catch {}
                    // Clear local profile
                    localStorage.removeItem('st_profile_name');
                    localStorage.removeItem('st_profile_email');
                    alert('You have been logged out.');
                });
            }
        })();
        
        document.getElementById('yourBookings').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('bookingDetailsTitle').innerText = "Your Bookings";
            const saved = JSON.parse(localStorage.getItem('st_bookings') || '[]');
            if (saved.length === 0) {
                document.getElementById('bookingDetailsContent').innerHTML = `<p class="text-gray-600">No bookings yet.</p>`;
            } else {
                document.getElementById('bookingDetailsContent').innerHTML = saved.map(b => `<div class="p-3 border rounded mb-2"><p><strong>Route:</strong> ${b.start} ‚Üí ${b.end}</p><p><strong>Date:</strong> ${b.date || 'Today'}</p><p><strong>Pass:</strong> ${b.passType || 'General Boarding'}</p></div>`).join('');
            }
            bookingsDetailsModal.classList.remove('hidden');
        });

        document.getElementById('previousBookings').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('bookingDetailsTitle').innerText = "Previous Bookings";
            const saved = JSON.parse(localStorage.getItem('st_bookings_prev') || '[]');
            if (saved.length === 0) {
                document.getElementById('bookingDetailsContent').innerHTML = `<p class="text-gray-600">No previous bookings.</p>`;
            } else {
                document.getElementById('bookingDetailsContent').innerHTML = saved.map(b => `<div class="p-3 border rounded mb-2"><p><strong>Route:</strong> ${b.start} ‚Üí ${b.end}</p><p><strong>Date:</strong> ${b.date || ''}</p><p><strong>Pass:</strong> ${b.passType || 'General Boarding'}</p></div>`).join('');
            }
            bookingsDetailsModal.classList.remove('hidden');
        });

        document.getElementById('closeBookingsDetailsModal').addEventListener('click', () => {
            bookingsDetailsModal.classList.add('hidden');
        });


        // Help Modal
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        const faqSection = document.getElementById('faq-section');

        const faqs = [
            { q: "How do I search for a bus?", a: "You can search for a bus using two methods. Use the main search bar on the homepage to search by 'From' and 'To' locations. Alternatively, in the 'Where is my Bus?' section, you can search by route or by bus number for more specific results." },
            { q: "How does the live map work?", a: "The live map shows the real-time location of buses and bus stops. Your location is marked with a blue pin, and buses are marked with red pins. You can refresh the locations at any time using the buttons below the map." },
            { q: "How do I book a ticket?", a: "After searching for a route, a 'Get Boarding Pass' button will appear. Click it to open a confirmation pop-up. This pass allows you to board any bus on that specific route." },
            { q: "How can I check my past bookings?", a: "Click on the 'Bookings' link in the top navigation bar, and then select 'Previous Bookings' from the dropdown menu. A pop-up will display a list of your past journeys." },
            { q: "How is the Predictive ETA calculated?", a: "Our Predictive ETA uses a smart algorithm that considers the number of stops, the base travel time, and average traffic conditions to give you an accurate estimate of your journey's duration." },
            { q: "What is the Smart Route Planner?", a: "The Smart Route Planner helps you find the best bus route between two locations. Simply enter your start and end points, and it will recommend the most efficient bus route available." },
            { q: "How do I use the Chatbot?", a: "Click on the 'Chat' button to open the chatbot window. You can ask 'Mr. Conductor' questions about bus routes, timings, and schedules, and it will provide you with helpful information based on our data." }
        ];

        function openHelpModal() {
            helpModal.classList.remove('hidden');
            renderFaqs();
        }

        function renderFaqs() {
            faqSection.innerHTML = '';
            faqs.forEach(faq => {
                const faqItem = document.createElement('div');
                faqItem.classList.add('mb-4');
                faqItem.innerHTML = `<h4 class="font-bold text-lg">${faq.q}</h4><p class="text-gray-700">${faq.a}</p>`;
                faqSection.appendChild(faqItem);
            });
        }

        closeHelpModal.addEventListener('click', () => {
            helpModal.classList.add('hidden');
        });

        document.getElementById('helpLink').addEventListener('click', (e) => {
            e.preventDefault();
            openHelpModal();
        });

        // Inject Driver/User buttons into navbar
        (function injectAuthButtons(){
            try {
                const navRight = document.querySelector('nav .flex.items-center.space-x-2');
                if (!navRight) return;
                const driverBtn = document.createElement('button');
                driverBtn.className = 'bg-amber-500 text-white px-4 py-2 rounded-full shadow hover:bg-amber-600';
                driverBtn.textContent = 'Driver Mode';
                driverBtn.addEventListener('click', ()=> document.getElementById('driverModal').classList.remove('hidden'));
                const userBtn = document.createElement('button');
                userBtn.className = 'bg-indigo-600 text-white px-4 py-2 rounded-full shadow hover:bg-indigo-700';
                userBtn.textContent = 'User Login';
                userBtn.addEventListener('click', ()=> document.getElementById('userAuthModal').classList.remove('hidden'));
                navRight.appendChild(driverBtn);
                navRight.appendChild(userBtn);
            } catch {}
        })();

        // Driver modal
        (function injectDriverModal(){
            const wrap = document.createElement('div');
            wrap.id = 'driverModal';
            wrap.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[6000] ui-overlay';
            wrap.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
                    <button id="closeDriverModal" class="absolute top-3 right-4 text-2xl text-gray-500 hover:text-black">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-amber-600">Driver Registration</h3>
                    <div class="space-y-3">
                        <input id="drvName" class="w-full border rounded px-3 py-2" placeholder="Driver Name" />
                        <input id="drvBusNumber" class="w-full border rounded px-3 py-2" placeholder="Bus Number (e.g., PB03N1234)" />
                        <input id="drvRouteId" class="w-full border rounded px-3 py-2" placeholder="Assigned Route ID (e.g., 58)" />
                        <input id="drvEmail" class="w-full border rounded px-3 py-2" placeholder="Email" type="email" />
                        <input id="drvPassword" class="w-full border rounded px-3 py-2" placeholder="Password" type="password" />
                        <button id="registerDriverBtn" class="w-full bg-amber-600 text-white py-2 rounded hover:bg-amber-700">Register Driver</button>
                    </div>
                    <hr class="my-4"/>
                    <div class="space-y-2">
                        <button id="startTrackingBtn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Start Tracking</button>
                        <button id="stopTrackingBtn" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">Stop Tracking</button>
                    </div>
                    <p id="driverStatus" class="text-sm text-gray-600 mt-3"></p>
                </div>
            `;
            document.body.appendChild(wrap);
            wrap.querySelector('#closeDriverModal').addEventListener('click', ()=> wrap.classList.add('hidden'));
            wrap.querySelector('#registerDriverBtn').addEventListener('click', async ()=>{
                const name = wrap.querySelector('#drvName').value.trim();
                const busNumber = wrap.querySelector('#drvBusNumber').value.trim();
                const routeId = wrap.querySelector('#drvRouteId').value.trim();
                const email = wrap.querySelector('#drvEmail').value.trim();
                const password = wrap.querySelector('#drvPassword').value.trim();
                try {
                    await registerDriver(name, busNumber, routeId, email, password);
                    wrap.querySelector('#driverStatus').textContent = 'Driver registered successfully.';
                } catch(e){
                    wrap.querySelector('#driverStatus').textContent = 'Registration failed. ' + (e?.message||'');
                }
            });
            wrap.querySelector('#startTrackingBtn').addEventListener('click', startTracking);
            wrap.querySelector('#stopTrackingBtn').addEventListener('click', stopTracking);
        })();

        // User modal
        (function injectUserModal(){
            const wrap = document.createElement('div');
            wrap.id = 'userAuthModal';
            wrap.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[6000] ui-overlay';
            wrap.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
                    <button id="closeUserModal" class="absolute top-3 right-4 text-2xl text-gray-500 hover:text-black">&times;</button>
                    <h3 class="text-xl font-bold mb-4 text-indigo-600">User Authentication</h3>
                    <div class="space-y-3">
                        <input id="usrEmail" class="w-full border rounded px-3 py-2" placeholder="Email" type="email" />
                        <input id="usrPassword" class="w-full border rounded px-3 py-2" placeholder="Password" type="password" />
                        <div class="grid grid-cols-2 gap-2">
                            <button id="userRegisterBtn" class="bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Register</button>
                            <button id="userLoginBtn" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
                        </div>
                        <button id="userLogoutBtn" class="w-full bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200">Logout</button>
                    </div>
                    <p id="userAuthStatus" class="text-sm text-gray-600 mt-3"></p>
                </div>
            `;
            document.body.appendChild(wrap);
            wrap.querySelector('#closeUserModal').addEventListener('click', ()=> wrap.classList.add('hidden'));
            wrap.querySelector('#userRegisterBtn').addEventListener('click', async ()=>{
                const email = wrap.querySelector('#usrEmail').value.trim();
                const password = wrap.querySelector('#usrPassword').value.trim();
                try { await userRegister(email, password); wrap.querySelector('#userAuthStatus').textContent = 'Registered. You can now login.'; }
                catch(e){ wrap.querySelector('#userAuthStatus').textContent = 'Registration failed. ' + (e?.message||''); }
            });
            wrap.querySelector('#userLoginBtn').addEventListener('click', async ()=>{
                const email = wrap.querySelector('#usrEmail').value.trim();
                const password = wrap.querySelector('#usrPassword').value.trim();
                try { await userLogin(email, password); wrap.querySelector('#userAuthStatus').textContent = 'Logged in.'; updateBusPositions(); }
                catch(e){ wrap.querySelector('#userAuthStatus').textContent = 'Login failed. ' + (e?.message||''); }
            });
            wrap.querySelector('#userLogoutBtn').addEventListener('click', async ()=>{
                try { await userLogout(); wrap.querySelector('#userAuthStatus').textContent = 'Logged out.'; }
                catch(e){ wrap.querySelector('#userAuthStatus').textContent = 'Logout failed. ' + (e?.message||''); }
            });
        })();

        // Firebase-backed driver profile and tracking
        async function registerDriver(name, busNumber, routeId, email, password){
            if (!name || !busNumber || !routeId || !email || !password) throw new Error('All fields are required.');
            const cred = await createUserWithEmailAndPassword(getAuth(), email, password);
            const uid = cred.user.uid;
            await setDoc(doc(getFirestore(), 'drivers', uid), { name, busNumber, routeId, email, createdAt: serverTimestamp() });
        }

        let geoWatchId = null, latestPosition = null, trackingIntervalHandle = null;
        async function startTracking(){
            const user = getAuth().currentUser;
            if (!user) { alert('Please register/login as driver first.'); return; }
            const drvSnap = await getDoc(doc(getFirestore(), 'drivers', user.uid));
            if (!drvSnap.exists()) { alert('Driver profile not found. Register first.'); return; }
            const { routeId, busNumber } = drvSnap.data() || {};
            if (!routeId || !busNumber) { alert('Driver profile incomplete (routeId/busNumber missing).'); return; }

            if (navigator.geolocation){
                if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
                geoWatchId = navigator.geolocation.watchPosition(
                    (pos)=>{ latestPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude }; },
                    (err)=>{ console.error('Geolocation error:', err); },
                    { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
                );
            } else { alert('Geolocation not supported.'); return; }

            if (trackingIntervalHandle) clearInterval(trackingIntervalHandle);
            trackingIntervalHandle = setInterval(async ()=>{
                if (!latestPosition) return;
                try {
                    const docId = `${routeId}_${busNumber}`;
                    await setDoc(doc(getFirestore(), 'liveBusLocations', docId), {
                        routeId, busNumber, lat: latestPosition.lat, lon: latestPosition.lon, timestamp: serverTimestamp()
                    }, { merge: true });
                } catch(e){ console.error('Failed to update location:', e); }
            }, 10000);
        }

        function stopTracking(){
            if (geoWatchId !== null) { navigator.geolocation.clearWatch(geoWatchId); geoWatchId = null; }
            if (trackingIntervalHandle) { clearInterval(trackingIntervalHandle); trackingIntervalHandle = null; }
        }

        async function userRegister(email, password){ if (!email || !password) throw new Error('Email and password required.'); await createUserWithEmailAndPassword(getAuth(), email, password); }
        async function userLogin(email, password){ if (!email || !password) throw new Error('Email and password required.'); await signInWithEmailAndPassword(getAuth(), email, password); }
        async function userLogout(){
            await signOut(getAuth());
            if (typeof unsubscribeLive === 'function') { try { unsubscribeLive(); } catch {} unsubscribeLive = null; }
            if (liveMarkers && liveMarkers.size) { liveMarkers.forEach(m=>{ try { map.removeLayer(m); } catch{} }); liveMarkers.clear(); }
        }

        let liveMarkers = new Map();
        function upsertMarker(docId, data){
            if (typeof map === 'undefined' || !map) return;
            const { lat, lon, routeId, busNumber } = data;
            if (typeof lat !== 'number' || typeof lon !== 'number') return;
            const existing = liveMarkers.get(docId);
            if (existing){
                existing.setLatLng([lat, lon]).setPopupContent(`<strong>Bus:</strong> ${busNumber}<br/><strong>Route:</strong> ${routeId}`);
            } else {
                const marker = L.marker([lat, lon], { icon: new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                }) }).addTo(map).bindPopup(`<strong>Bus:</strong> ${busNumber}<br/><strong>Route:</strong> ${routeId}`);
                liveMarkers.set(docId, marker);
            }
        }
        function removeMarker(docId){ const m = liveMarkers.get(docId); if (m){ try { map.removeLayer(m); } catch{} liveMarkers.delete(docId); } }

        let unsubscribeLive = null;
        function updateBusPositions(){
            if (unsubscribeLive) return;
            try {
                const colRef = collection(getFirestore(), 'liveBusLocations');
                unsubscribeLive = onSnapshot(colRef, (snapshot)=>{
                    snapshot.docChanges().forEach((change)=>{
                        const docId = change.doc.id;
                        if (change.type === 'removed') removeMarker(docId); else upsertMarker(docId, change.doc.data());
                    });
                }, (err)=> console.error('liveBusLocations onSnapshot error:', err));
            } catch(e){ console.error('Failed to subscribe to liveBusLocations:', e); }
        }

        onAuthStateChanged(getAuth(), (user)=>{ if (user) updateBusPositions(); });

        // If you want to disable simulation after enabling live updates, comment these lines:
        // simulateBusMovement();
        loadBusData();
        const savedLang = localStorage.getItem('st_language') || 'en';
        document.getElementById('language-selector').value = savedLang;
        setLanguage(savedLang);
    </script>
</body>
</html>
}

